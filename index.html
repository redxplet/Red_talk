import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const db = getFirestore(app);

window.loginUser = async function () {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const rememberMe = document.getElementById("rememberMe").checked;
  const message = document.getElementById("message");

  message.style.color = "white";
  message.textContent = "";

  const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;

  try {
    await setPersistence(auth, persistence);
    const userCredential = await signInWithEmailAndPassword(auth, email, password);

    // جلب رمز المستخدم من Firestore
    const q = query(collection(db, "users"), where("uid", "==", userCredential.user.uid));
    const querySnapshot = await getDocs(q);
    if (!querySnapshot.empty) {
      const userData = querySnapshot.docs[0].data();
      console.log("رمز المستخدم:", userData.code);
      message.textContent = `تم تسجيل الدخول! رمزك: ${userData.code}`;
    }

    message.style.color = "#10b981";
    setTimeout(() => {
      window.location.href = "home.html";
    }, 1500);

  } catch (error) {
    message.style.color = "#f87171";
    if (error.code === "auth/user-not-found" || error.code === "auth/wrong-password") {
      message.textContent = "البريد أو كلمة المرور غير صحيحة.";
    } else {
      message.textContent = "حدث خطأ: " + error.message;
    }
  }
};
